<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PDF Review – Auto Sections + Comments</title>
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <style>
  /* Menjamin layout penuh tanpa scroll di luar */
  body, html {
    margin: 0;
    padding: 0;
    height: 100%;
  }

  /* Menjamin agar area-panel tidak menggantung dan mengisi seluruh tinggi layar */
  .main-container {
    display: grid;
    grid-template-columns: 3fr 6fr 3fr; /* Kolom untuk Sections, PDF Viewer, Comments */
    height: 80vh; /* Full screen height */
    gap: 1rem;
  }

  /* Styling untuk bagian "Sections", "PDF Viewer", dan "Comments" */
  .pane {
    height: 100%;
    max-height: calc(100vh - 100px); /* Mengatur maksimal tinggi agar tidak melimpah */
    overflow: auto; /* Menambahkan scroll jika konten melimpah */
  }

  .footer-pane {
    height: 140px;
  }

  /* Styling untuk line numbers di PDF viewer */
  .ln-col {
    width: 56px;
  }

  .ln-list {
    font-variant-numeric: tabular-nums;
    font-size: 12px;
    color: #6b7280;
  }

  .ln-list div {
    padding: 2px 6px;
  }

  .ln-active {
    font-weight: 700;
    color: #111827;
    background: #f3f4f6;
    border-radius: 6px;
  }

  .doc-page {
    display: grid;
    grid-template-columns: 56px 1fr;
  }

  .doc-canvas {
    display: block;
    margin: 0 auto;
    background: #fff;
    transition: box-shadow .2s;
  }

  .flash {
    box-shadow: 0 0 0 3px #a3e635 inset;
  }

  .sec-btn {
    width: 100%;
    text-align: left;
  }

  .sec-btn.active {
    background: #eef2ff;
  }

  .highlight {
    background-color: rgba(255, 255, 0, 0.5);
  }
  </style>
</head>
<body class="bg-neutral-100 text-neutral-900">
  <header class="border-b bg-white">
    <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between">
      <div class="flex items-center gap-3">
        <span class="text-xl font-semibold">PDF Review</span>
        <span class="px-2 py-0.5 text-xs rounded bg-neutral-100 border">Auto Sections</span>
      </div>
      <div class="flex items-center gap-2">
        <button id="helpBtn" class="px-3 py-2 text-sm border rounded-lg hover:bg-neutral-50">Help</button>
        <label class="px-3 py-2 text-sm border rounded-lg bg-neutral-50 hover:bg-neutral-100 cursor-pointer">
          Upload PDF <input id="fileInput" type="file" accept="application/pdf" class="hidden"/>
        </label>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 pt-4">
    <div class="main-container">
      <!-- LEFT: Sections (auto dari outline/header) -->
      <aside class="pane bg-white border rounded-xl p-3 overflow-auto">
        <h3 class="font-semibold mb-2">Sections</h3>
        <ul id="sectionsList" class="space-y-1 text-sm"></ul>
        <p id="sectionsHint" class="mt-3 text-xs text-neutral-500 hidden">
          * Outline tidak ditemukan — menampilkan judul (font besar) hasil deteksi otomatis.
        </p>
      </aside>

      <!-- CENTER: PDF viewer dengan line numbers -->
      <section class="pane bg-white border rounded-xl p-0 overflow-auto" id="viewerPane">
        <div class="px-4 py-2 border-b flex justify-between">
          <div class="font-semibold">Doc Viewer</div>
          <div id="docMeta" class="text-xs text-neutral-500">Belum ada PDF</div>
        </div>
        <div id="pdfContainer" class="p-4 text-center text-neutral-500">
          Upload PDF untuk ditampilkan di sini.
        </div>
      </section>

      <!-- RIGHT: Comments (History di bawah tombol) -->
      <aside class="pane bg-white border rounded-xl p-3 overflow-auto">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">Comments</h3>
          <span id="currentTarget" class="text-xs text-neutral-500">Page – • Line –</span>
        </div>
        <textarea id="commentInput" class="w-full h-40 border rounded-lg p-2 text-sm"
          placeholder="Tulis komentar untuk page & line terpilih…"></textarea>
        <div class="mt-2 flex items-center gap-2">
          <button id="addBtn" class="px-3 py-2 text-sm rounded-lg bg-neutral-900 text-white hover:opacity-90">Add</button>
          <button id="downloadBtn" class="ml-auto px-3 py-2 text-sm rounded-lg border hover:bg-neutral-50">Download CSV</button>
        </div>
        <div class="mt-4">
          <h4 class="font-semibold mb-2">History</h4>
          <ul id="historyList" class="text-sm space-y-2"></ul>
        </div>
      </aside>
    </div>
  </main>

  <script>
    /* ===== STATE ===== */
    let pdfDoc = null, scale = 0.8, lineHeight = 22;
    const pages = [];   // {pageNum, canvas, lnCol, totalLines, sectionName}
    const comments = [];
    const highlights = []; // Array to store highlights for each page.

    /* ===== DOM ===== */
    const fileInput = document.getElementById('fileInput');
    const pdfContainer = document.getElementById('pdfContainer');
    const docMeta = document.getElementById('docMeta');
    const sectionsList = document.getElementById('sectionsList');
    const sectionsHint = document.getElementById('sectionsHint');
    const currentTarget = document.getElementById('currentTarget');
    const historyList = document.getElementById('historyList');
    const commentInput = document.getElementById('commentInput');
    const addBtn = document.getElementById('addBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const dashStats = document.getElementById('dashStats');

    /* ===== Helpers ===== */
    function escapeHtml(s) {
      return s.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m]);
    }

    function updateDash() { dashStats.textContent = `${comments.length} komentar, ${pages.length} halaman dimuat.`; }

    function buildLineNumbers(h) { 
      const d = document.createElement('div'); 
      d.className = "ln-list"; 
      const tot = Math.max(1, Math.floor(h / lineHeight)); 
      for (let i = 1; i <= tot; i++) { 
        const e = document.createElement('div'); 
        e.textContent = i; 
        d.appendChild(e); 
      } 
      return { node: d, total: tot }; 
    }

    function highlightLine(pageIdx, line) { 
      const items = pages[pageIdx].lnCol.querySelectorAll('.ln-list div'); 
      items.forEach((el, i) => el.classList.toggle('ln-active', i + 1 === line)); 
    }

    function setCurrent(page, line) { 
      currentTarget.textContent = `Page ${page} • Line ${line}`; 
      currentTarget.dataset.page = page; 
      currentTarget.dataset.line = line; 
    }
    
    function highlightText(pageNum, positions) {
      const canvas = pages[pageNum - 1].canvas;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = 'rgba(255, 255, 0, 0.5)';  // Highlight color (yellow)
      positions.forEach(pos => {
        ctx.fillRect(pos.x, pos.y, pos.width, pos.height);
      });
      highlights[pageNum - 1] = positions;  // Store the highlights for the page
    }

    function goTo(pageNum, yPdf = null) {
      const target = document.getElementById(`page-${pageNum}`);
      if (!target) return;
      
      // Scroll secara otomatis ke halaman yang tepat
      target.scrollIntoView({ behavior: 'smooth', block: 'start' });
      
      const pg = pages[pageNum - 1];

      if (yPdf !== null && !isNaN(yPdf)) {
        const yCanvas = pg.canvas.height - (yPdf * scale);
        const line = Math.max(1, Math.min(pg.totalLines, Math.round(yCanvas / lineHeight)));
        
        highlightLine(pageNum - 1, line); // Highlight bagian yang relevan
        setCurrent(pageNum, line);  // Menampilkan informasi page dan line
      }
      
      // Memberikan efek flash pada halaman untuk menandai
      pg.canvas.classList.add('flash');
      setTimeout(() => pg.canvas.classList.remove('flash'), 600);
    }

    /* ===== Render PDF ===== */
    async function renderPDF(buf) {
      pages.length = 0;
      highlights.length = 0;
      pdfContainer.innerHTML = "";
      pdfDoc = await pdfjsLib.getDocument({ data: buf }).promise;
      docMeta.textContent = `${pdfDoc.numPages} halaman`;

      for (let p = 1; p <= pdfDoc.numPages; p++) {
        const page = await pdfDoc.getPage(p);
        const viewport = page.getViewport({ scale });

        const wrap = document.createElement('div');
        wrap.className = "doc-page mb-6"; wrap.id = `page-${p}`;

        const lnCol = document.createElement('div'); lnCol.className = "ln-col select-none pt-4";
        const { node, total } = buildLineNumbers(viewport.height); lnCol.appendChild(node);

        const canvas = document.createElement('canvas');
        canvas.height = viewport.height; canvas.width = viewport.width;
        const ctx = canvas.getContext('2d', { alpha: false });
        canvas.className = "doc-canvas"; canvas.title = `Page ${p}`;

        canvas.addEventListener('click', e => {
          const rect = canvas.getBoundingClientRect();
          const y = e.clientY - rect.top;
          const line = Math.max(1, Math.min(total, Math.round(y / lineHeight)));
          highlightLine(p - 1, line); setCurrent(p, line);
        });

        wrap.appendChild(lnCol); wrap.appendChild(canvas); pdfContainer.appendChild(wrap);
        await page.render({ canvasContext: ctx, viewport }).promise;

        pages.push({ pageNum: p, canvas, lnCol, totalLines: total });
      }

      await buildSections(); // isi kiri
      updateDash();
    }

    /* ===== Sections kiri (Outline → fallback detect heading) ===== */
    async function buildSections() {
      sectionsList.innerHTML = "";
      sectionsHint.classList.add('hidden');

      const outline = await pdfDoc.getOutline();
      if (outline && outline.length) {
        const renderTree = (items, level = 0) => {
          items.forEach(item => {
            const li = document.createElement('li');
            li.style.marginLeft = (level * 10) + 'px';
            const btn = document.createElement('button');
            btn.className = "sec-btn px-2 py-2 rounded hover:bg-neutral-50";
            btn.textContent = item.title || 'Untitled';
            btn.addEventListener('click', async () => {
              // reset active state
              sectionsList.querySelectorAll('.sec-btn').forEach(b => b.classList.remove('active'));
              btn.classList.add('active');
              

              // Get destination of the bookmark (page index)
              const dest = await pdfDoc.getDestination(item.dest);
              const pageIndex = await pdfDoc.getPageIndex(dest[0]);

              let yPdf = null;
              if (Array.isArray(dest) && typeof dest[3] === 'number') {
                yPdf = dest[3];
              } else if (Array.isArray(dest) && typeof dest[2] === 'number') {
                yPdf = dest[2];
              }

              // Call the function to scroll and highlight
              goTo(pageIndex + 1, yPdf);  // Scroll ke halaman dan posisi y
            });
            li.appendChild(btn);
            sectionsList.appendChild(li);
            if (item.items && item.items.length) renderTree(item.items, level + 1);
          });
        };
        renderTree(outline, 0);
      } else {
        // fallback: deteksi heading (font besar) pada N halaman pertama
        sectionsHint.classList.remove('hidden');
        const MAX_SCAN = Math.min(1000, pdfDoc.numPages);
        for (let p = 1; p <= MAX_SCAN; p++) {
          const pg = await pdfDoc.getPage(p);
          const tc = await pg.getTextContent();
          tc.items.forEach(it => {
            const text = it.str ? it.str.trim() : '';
            if (!text || text.length < 4) return;
            const fs = Math.abs(it.transform?.[0] || 0);
            if (fs > 12) {
              const yPdf = it.transform?.[5] ?? null;
              const li = document.createElement('li');
              const btn = document.createElement('button');
              btn.className = "sec-btn px-2 py-2 rounded hover:bg-neutral-50";
              btn.textContent = `${text} (p${p})`;
              btn.addEventListener('click', () => {
                // reset active state
                sectionsList.querySelectorAll('.sec-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                goTo(p, yPdf);
                // Highlight section after navigation
                highlightText(p, getTextPositionsForSection(text));
              });
              li.appendChild(btn);
              sectionsList.appendChild(li);
            }
          });
        }
      }
    }

    async function getTextPositionsForSection(pageNum, sectionTitle) {
      const page = await pdfDoc.getPage(pageNum);
      const textContent = await page.getTextContent();
      const viewport = page.getViewport({ scale });

      const positions = [];
      textContent.items.forEach(item => {
        if (item.str && item.str.trim().toLowerCase().includes(sectionTitle.toLowerCase())) {
          const tx = pdfjsLib.Util.transform(
            viewport.transform,
            item.transform
          );
          const x = tx[4];
          const y = tx[5];
          const fontSize = Math.abs(item.transform[0]);
          positions.push({
            x,
            y: viewport.height - y,   // konversi koordinat PDF ke canvas
            width: item.width * scale,
            height: fontSize
          });
        }
      });

      return positions;
    }

    /* ===== Upload ===== */
    fileInput.addEventListener('change', async e => {
      const f = e.target.files[0]; if (!f) return;
      const ab = await f.arrayBuffer();
      await renderPDF(ab);
    });

    /* ===== Comments + CSV ===== */
    addBtn.addEventListener('click', () => {
      const page = parseInt(currentTarget.dataset.page || ''); const line = parseInt(currentTarget.dataset.line || '');
      const text = commentInput.value.trim();
      if (!page || !line) { alert('Klik pada dokumen untuk memilih Page & Line.'); return; }
      if (!text) { alert('Komentar masih kosong.'); return; }
      const ts = new Date();
      comments.push({ page, line, text, ts: ts.toISOString() });
      const li = document.createElement('li');
      li.innerHTML = `<div class="border rounded-lg p-2">
        <div class="text-xs text-neutral-500 mb-1">Page ${page} • Line ${line} • ${ts.toLocaleString()}</div>
        <div>${escapeHtml(text)}</div>
      </div>`;
      historyList.prepend(li);
      commentInput.value = ''; updateDash();
    });

    downloadBtn.addEventListener('click', () => {
      if (!comments.length) { alert('Belum ada komentar.'); return; }
      const rows = [['Page', 'Line', 'Comment', 'Timestamp']];
      for (const c of comments) { rows.push([c.page, c.line, c.text.replace(/\n/g, ' '), c.ts]); }
      const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(',')).join('\r\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'comments.csv';
      document.body.appendChild(a); a.click(); a.remove();
    });
  </script>
</body>
</html>
